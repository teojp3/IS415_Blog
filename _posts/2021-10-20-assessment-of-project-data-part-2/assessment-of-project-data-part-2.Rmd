---
title: "Assessment of Project Data Part 2"
description: |
  Testing if the newly chosen data sets  for the group project are appropriate and working well!
author:
  - name: Teo Jun Peng
    url: https://teojp3-is415.netlify.app/
date: 2021-10-20
output:
  distill::distill_article:
      self_contained: false
      toc: true
      toc_depth: 2
      toc_float: true
---

```{r setup, include=FALSE, eval=TRUE, echo=TRUE, message=FALSE, error=FALSE, fig.retina=3}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

# Setting up R Environment

As usual, loading in the relevant R packages that are helpful in the analysis process.

```{r results='hide'}
packages = c('readr','sp', 'sf', 'rgdal', 'spNetwork', 'tmap', 'FNN', 'spatstat', "raster")
  for (p in packages)
  {
    if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

# Data Sources

The following data will be used and tested:

- Road Network of Punggol, Singapore (Taken from Professor Kam Tin Seong from a previous Hands-on Exercise)
- Location of Childcare Centres in Punggol, Singapore (Taken from Professor Kam Tin Seong from a previous Hands-on Exercise)
- [Location of Bus Stops](https://datamall.lta.gov.sg/content/datamall/en.html)
- [MRT/LRT Stations](https://datamall.lta.gov.sg/content/datamall/en.html)
- Schools (Manually Complied from Google)


# Importing in Data

Data sets used has been pre-prepared and cleaned in ArcGIS Pro for higher efficiency.

Some data wrangling processes done are:

- Removing duplicates spatial points

- Clipping spatial data to within the study area of Punggol 

## Importing in Study Factors

### Network Data Set

The Road Network data set was taken from a previous exercise (Hands-on Exercise 5) guided by Professor Kam Tin Seong.

```{r}
network <- readOGR(dsn="data/Punggol", 
                   layer="Punggol_St",
                   verbose = FALSE)

network <- spTransform(network,CRS("+init=epsg:3414"))
```

### Study Factors

For this study that illustrates an example of Network-Constrained Point Patterns Analysis, we would like to uncover whether the **Bus Stops in Punggol, Singapore** are distributed randomly **along the road network** and if not, what are the factors that affect their locations.

### Main Data: Childcare Centres

The Childcare Centres data set is taken from a previous hands-on exercise guided by Professor Kam Tin Seong. 

```{r}
childcare <- readOGR(dsn="data/punggol",
                     layer="Punggol_CC",
                     verbose = FALSE)

childcare <-spTransform(childcare, CRS("+init=epsg:3414"))
```

### Cross K Factors

We will be using *three factors* to test out their correlation and relationship with the location of bus stops. The three factors are: **1) Bus Stops, 2) MRT/LRT Stations, 3) Schools**

Initially, the Bus Stops data set was to be the main data, but we faced problems with the data, so the Main Data is changed to Childcare Centres. The Bus Stops data set can be obtained from DataMall, which is under the official website of the Land Transport Authority (LTA) of Singapore.

```{r}
Bus <- readOGR(dsn="data/BusStop", 
                   layer="BusStop_P",
                   verbose = FALSE)

Bus <- spTransform(Bus,CRS("+init=epsg:3414"))

MRT <- readOGR(dsn="data/MRT", 
                   layer="MRT_P",
                   verbose = FALSE)

MRT <- spTransform(MRT,CRS("+init=epsg:3414"))

Schools <- read_csv("data/Schools.csv")

Schools <- st_as_sf(Schools, coords = c("Longitude", "Latitude"), crs = 4326) %>%
    st_transform(crs = 3414)

Schools <- as(Schools, "Spatial")
```


# Initial EDA and Mapping

The locations of the various factors are:

* Childcare Centres (Red)

* Bus Stops (Blue)

* MRT/LRT Stations (Green)

* Schools (Orange)

```{r}
tmap_mode('view')

tm_shape(network) +
  tm_lines() +
tm_shape(childcare) +
  tm_dots(col = 'red') +
tm_shape(Bus) +
  tm_dots(col = 'blue') +
tm_shape(MRT) +
  tm_dots(col = 'green') +
tm_shape(Schools) +
  tm_dots(col='orange')
```

So far so good! The data sets used looks quite promising, and we shall test out Kernel Density with them later on in the assessment :) .

# Network Constrained KDE (NetKDE) Analysis

We will perform NetKDE analysis by using appropriate functions provided in **spNetwork** package.

## Preparing the lixels objects

```{r}
lixels <- lixelize_lines(network,700,mindist = 350)
```

What can we learned from the code chunk above:

* The length of a lixel, lx_length is set to 1000m, and

* The minimum length of a lixel, mindist is set to 500m.

## Generating line centre points

Next, lines_center() of spNetwork will be used to generate a SpatialPointsDataFrame (i.e. samples) with line center points as shown in the code chunk below.

```{r}
samples <- lines_center(lixels)
```

## Performing NetKDE

```{r}
densities <- nkde(network, 
                  events = childcare,
                  w = rep(1,nrow(childcare)),
                  samples = samples,
                  kernel_name = "quartic",
                  bw = 300, 
                  div= "bw", 
                  method = "simple", 
                  digits = 1, 
                  tol = 1,
                  grid_shape = c(1,1), 
                  max_depth = 8,
                  agg = 5, #we aggregate events within a 5m radius (faster calculation)
                  sparse = TRUE,
                  verbose = FALSE)
```

*kernel_name* argument indicates that quartic kernel is used. Are possible kernel methods supported by spNetwork are: triangle, gaussian, scaled gaussian, tricube, cosine ,triweight, epanechnikov or uniform.

*method* argument indicates that simple method is used to calculate the NKDE. Currently, spNetwork support three popular methods, they are: simple, discontinuous, continuous.


## Visualising NetKDE

Before we can visualise the NetKDE values, the code chunk below will be used to insert the computed density values (i.e. densities) into samples and lixels objects as density field.

The density values will also be rescale from metre to kilometre, as the projection system uses Metre as the unit of measurement.

```{r}
samples$density <- densities
lixels$density <- densities

samples$density <- samples$density*1000
lixels$density <- lixels$density*1000
```

```{r}
tmap_mode('view')
tm_shape(lixels)+
  tm_lines(col="density")+
tm_shape(childcare)+
  tm_dots()
```

# Second Order Analysis

## Network Constrained K-Function Analysis

In this section, we are going to perform complete spatial randomness (CSR) test by using *kfunctions()* of **spNetwork** package. The null hypothesis is defined as:

**Ho: The observed spatial point events (i.e distribution of Childcare Centres) are uniformly distributed over the road network in Punggol Planning Area located in Singapore.**

```{r}
kfun_childcare <- kfunctions(network, 
                             childcare,
                             start = 0, 
                             end = 1000, 
                             step = 50, 
                             width = 50, 
                             nsim = 50, 
                             resolution = 50,
                             verbose = FALSE, 
                             conf_int = 0.05)
```

```{r}
kfun_childcare$plotk
```
The blue line is the empirical network K-function of the childcare centres in Punggol planning area. The gray envelope represents the results of the 50 simulations in the interval 2.5% - 97.5%. Because the blue line between the distance of 250m-400m are below the gray area, we can infer that the childcare centres in Punggol planning area resembles a regular pattern at the distance of 250m-400m.

So far looking good, we shall transfer the data over to the R Shiny Application.

## Network Constrained Cross K-Function Analysis

### Cross K between Childcare Centres and Bus Stops

```{r}
crossk_Bus <- cross_kfunctions(network, 
                               childcare,
                               Bus,
                               start = 0, 
                               end = 1000, 
                               step = 50, 
                               width = 50, 
                               nsim = 50, 
                               resolution = 50,
                               verbose = FALSE, 
                               conf_int = 0.05)
```

```{r}
crossk_Bus$plotk
```

### Cross K between Childcare Centres and MRT Stations

```{r}
crossk_MRT <- cross_kfunctions(network, 
                               childcare,
                               MRT,
                               start = 0, 
                               end = 1000, 
                               step = 50, 
                               width = 50, 
                               nsim = 50, 
                               resolution = 50,
                               verbose = FALSE, 
                               conf_int = 0.05)
```


```{r}
crossk_MRT$plotk
```

### Cross K between Childcare Centres and Schools 

```{r}
crossk_schools <- cross_kfunctions(network, 
                               Schools,
                               MRT,
                               start = 0, 
                               end = 1000, 
                               step = 50, 
                               width = 50, 
                               nsim = 50, 
                               resolution = 50,
                               verbose = FALSE, 
                               conf_int = 0.05)
```


```{r}
crossk_schools$plotk
```










